/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JDialog.java to edit this template
 */
package ui;

import Logica.FachadaServicios;
import Logica.observer.Observable;
import Logica.observer.Observer;
import controlador.DialogoMozoControlador;
import dominio.Cliente;
import dominio.ItemServicio;
import dominio.Mesa;
import dominio.Mozo;
import dominio.Producto;
import dominio.Servicio;
import dominio.Sesion;
import dominio.Usuario;
import exceptions.AgregarProductoServicioException;
import java.awt.Color;
import java.awt.Component;
import java.awt.Frame;
import java.awt.HeadlessException;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.JToggleButton;
import javax.swing.ListCellRenderer;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author yamil
 */
public class DialogoMozo extends javax.swing.JDialog implements DialogoMozoVista, Observer{
    
    private Mozo mozo;
    private DialogoMozoControlador controlador;
    private Sesion sesion;
    DefaultTableModel dtm;

    /**
     * Creates new form DialogoMozo
     */
    public DialogoMozo(java.awt.Frame parent, boolean modal, Mozo mozo) {
        super(parent, modal);
        initComponents();
        this.mozo= mozo;
        this.controlador= new DialogoMozoControlador(this);
        sesion = new Sesion(mozo, new Date());
        controlador.iniciarSesion(sesion);
        dtm = (DefaultTableModel) tblServicio.getModel();
        this.setTitle("Ventana mozo");
        ejecutarCu1();
    }
    
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        lblServicioMesa = new javax.swing.JLabel();
        btnAbrir = new javax.swing.JButton();
        btnCerrar = new javax.swing.JButton();
        btnTransferir = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        listProductos = new javax.swing.JList();
        lblMesasMozo = new javax.swing.JLabel();
        txtCantidadProducto = new javax.swing.JTextField();
        lblCantidadProducto = new javax.swing.JLabel();
        lblDescripcionProducto = new javax.swing.JLabel();
        txtDescripcionProducto = new javax.swing.JTextField();
        btnAgregarItemServicio = new javax.swing.JButton();
        lblProductosDisponilbes = new javax.swing.JLabel();
        jScrollPane2 = new javax.swing.JScrollPane();
        tblServicio = new javax.swing.JTable();
        jScrollPane3 = new javax.swing.JScrollPane();
        listMesas = new javax.swing.JList();
        btnSalir = new javax.swing.JButton();
        btnAgregarProducto = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        lblServicioMesa.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        lblServicioMesa.setText("Servicio de la mesa:");

        btnAbrir.setText("Abrir");
        btnAbrir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAbrirActionPerformed(evt);
            }
        });

        btnCerrar.setText("Cerrar");
        btnCerrar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCerrarActionPerformed(evt);
            }
        });

        btnTransferir.setText("Transferir");
        btnTransferir.setToolTipText("");
        btnTransferir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTransferirActionPerformed(evt);
            }
        });

        jScrollPane1.setViewportView(listProductos);

        lblMesasMozo.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N
        lblMesasMozo.setText("Mesas del mozo: ");

        lblCantidadProducto.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        lblCantidadProducto.setText("Ingrese la cantidad");

        lblDescripcionProducto.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        lblDescripcionProducto.setText("Ingrese una descripcion");

        btnAgregarItemServicio.setText("Agregar");
        btnAgregarItemServicio.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAgregarItemServicioActionPerformed(evt);
            }
        });

        lblProductosDisponilbes.setFont(new java.awt.Font("Arial", 1, 12)); // NOI18N
        lblProductosDisponilbes.setText("Productos disponibles:");

        tblServicio.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Cant.", "Producto", "Descripcion", "P. Unit.", "Subtotal", "Estado", "Gestor"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        tblServicio.setName(""); // NOI18N
        tblServicio.setOpaque(false);
        jScrollPane2.setViewportView(tblServicio);

        listMesas.setBackground(new java.awt.Color(204, 204, 204));
        listMesas.setBorder(javax.swing.BorderFactory.createBevelBorder(javax.swing.border.BevelBorder.RAISED));
        listMesas.setFont(new java.awt.Font("Arial Black", 0, 18)); // NOI18N
        listMesas.setToolTipText("");
        listMesas.setCursor(new java.awt.Cursor(java.awt.Cursor.DEFAULT_CURSOR));
        listMesas.setMaximumSize(new java.awt.Dimension(45, 100));
        listMesas.setMinimumSize(new java.awt.Dimension(45, 100));
        listMesas.setSelectionBackground(new java.awt.Color(204, 204, 204));
        listMesas.setVisibleRowCount(5);
        listMesas.addListSelectionListener(new javax.swing.event.ListSelectionListener() {
            public void valueChanged(javax.swing.event.ListSelectionEvent evt) {
                listMesasValueChanged(evt);
            }
        });
        jScrollPane3.setViewportView(listMesas);

        btnSalir.setText("Salir");
        btnSalir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSalirActionPerformed(evt);
            }
        });

        btnAgregarProducto.setText("Agregar Producto");
        btnAgregarProducto.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAgregarProductoActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 750, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 141, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                                .addComponent(btnCerrar, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                .addComponent(btnAgregarProducto, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                .addComponent(btnTransferir, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                            .addComponent(btnAbrir, javax.swing.GroupLayout.PREFERRED_SIZE, 113, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 276, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(lblCantidadProducto)
                            .addComponent(btnAgregarItemServicio)
                            .addComponent(txtCantidadProducto, javax.swing.GroupLayout.PREFERRED_SIZE, 133, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(txtDescripcionProducto)
                            .addComponent(lblDescripcionProducto, javax.swing.GroupLayout.DEFAULT_SIZE, 134, Short.MAX_VALUE)))
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(lblMesasMozo, javax.swing.GroupLayout.PREFERRED_SIZE, 295, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(lblProductosDisponilbes))
                    .addComponent(btnSalir)
                    .addComponent(lblServicioMesa, javax.swing.GroupLayout.PREFERRED_SIZE, 619, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(btnSalir)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblProductosDisponilbes)
                    .addComponent(lblMesasMozo))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(lblCantidadProducto)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtCantidadProducto, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(lblDescripcionProducto)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtDescripcionProducto)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnAgregarItemServicio))
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 133, Short.MAX_VALUE)
                    .addComponent(jScrollPane3)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(15, 15, 15)
                        .addComponent(btnAbrir)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnAgregarProducto)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnCerrar)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btnTransferir)))
                .addGap(41, 41, 41)
                .addComponent(lblServicioMesa)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 105, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(73, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnAbrirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAbrirActionPerformed
        abrirMesa();
    }//GEN-LAST:event_btnAbrirActionPerformed

    private void btnCerrarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCerrarActionPerformed
        cerrarMesa();
    }//GEN-LAST:event_btnCerrarActionPerformed

    private void btnTransferirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTransferirActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_btnTransferirActionPerformed

    private void btnAgregarItemServicioActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAgregarItemServicioActionPerformed
        try {
            agregarProductoAlServicio();
        } catch (AgregarProductoServicioException ex) {
            Logger.getLogger(DialogoMozo.class.getName()).log(Level.SEVERE, null, ex);
        }
    }//GEN-LAST:event_btnAgregarItemServicioActionPerformed

    private void btnSalirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSalirActionPerformed
        salir();
    }//GEN-LAST:event_btnSalirActionPerformed

    private void btnAgregarProductoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAgregarProductoActionPerformed
        cargarProductosDisponibles();
    }//GEN-LAST:event_btnAgregarProductoActionPerformed

    private void listMesasValueChanged(javax.swing.event.ListSelectionEvent evt) {//GEN-FIRST:event_listMesasValueChanged
        cargarServicioDeLaMesa();
    }//GEN-LAST:event_listMesasValueChanged

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAbrir;
    private javax.swing.JButton btnAgregarItemServicio;
    private javax.swing.JButton btnAgregarProducto;
    private javax.swing.JButton btnCerrar;
    private javax.swing.JButton btnSalir;
    private javax.swing.JButton btnTransferir;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JLabel lblCantidadProducto;
    private javax.swing.JLabel lblDescripcionProducto;
    private javax.swing.JLabel lblMesasMozo;
    private javax.swing.JLabel lblProductosDisponilbes;
    private javax.swing.JLabel lblServicioMesa;
    private javax.swing.JList listMesas;
    private javax.swing.JList listProductos;
    private javax.swing.JTable tblServicio;
    private javax.swing.JTextField txtCantidadProducto;
    private javax.swing.JTextField txtDescripcionProducto;
    // End of variables declaration//GEN-END:variables

    @Override
    public void cerrarVista() {
        this.dispose();
    }

    @Override
    public void mostrarError(String mensaje) {
        JOptionPane.showMessageDialog(this, mensaje,"Error", JOptionPane.ERROR_MESSAGE);
    }
    
    private void ejecutarCu1() {
        cargarNombreMozo();
        cargarMesasMozo();
    }
    
    public void cargarNombreMozo(){
        String nombreCompleto= controlador.nombreCompletoMozo(this.mozo);
        lblMesasMozo.setText("Mesas del mozo: "+nombreCompleto);
    }
    
    public void cargarMesasMozo(){
        if(this.mozo!=null){
            ArrayList<Mesa> mesasMozo= controlador.conjuntoMesasDeMozo(this.mozo);
            if(!mesasMozo.isEmpty()){
                listMesas.setCellRenderer(new MesasRenderer());
                listMesas.setListData(mesasMozo.toArray());
            }
        }
    }
    
    //////////////////////////////////////////////////////////////////
    //   //*CU: Abrir una mesa                                      //               
    ////////////////////////////////////////////////////////////////// 
    
    public void abrirMesa() {
        Mesa mesaSeleccionada= (Mesa) listMesas.getSelectedValue();
        if(controlador.abrirMesa(mesaSeleccionada, this.mozo)){
            cargarMesasMozo();
        }
    }
    
    //////////////////////////////////////////////////////////////////
    //   //CU: Agregar un producto al servicio                      //               
    ////////////////////////////////////////////////////////////////// 
    //) El mozo selecciona una mesa
    //El sistema muestra los datos del servicio de la mesa
    private void cargarServicioDeLaMesa(){
        dtm.setNumRows(0);
        Mesa mesa= (Mesa) listMesas.getSelectedValue();
        if(controlador.mesaEstaAbierta(mesa)){
            lblServicioMesa.setText("Servicio de la mesa: "+mesa.getNumero());
            Servicio servicio= controlador.getServicioMesa(mesa);
            if(servicio!=null){
                cargarServicioCompleto(servicio);
            }
        }else{
            lblServicioMesa.setText("La mesa "+mesa.getNumero()+" está cerrada.");
            listMesas.clearSelection();
        }
    }
    
    //El mozo indica que desea agregar un producto al servicio.
    // El sistema muestra la lista de productos con stock disponible.
    private void cargarProductosDisponibles() {
       listProductos.setListData(controlador.getProductosDisponibles().toArray());
    }
    
    //El mozo selecciona un producto, ingresa la cantidad y opcionalmente una descripción.
    //El sistema descuenta el stock del producto ingresado, envía el pedido a la unidad 
    //procesadora correspondiente al producto (cocina, bar, etc) y mostrará los datos 
    //actualizados del servicio
    private void agregarProductoAlServicio() throws AgregarProductoServicioException {
        Mesa mesa= (Mesa) listMesas.getSelectedValue();
        Producto producto= (Producto) listProductos.getSelectedValue();
        String descripcion= txtDescripcionProducto.getText();
        String cantidad= txtCantidadProducto.getText();
        int cantidadP=Integer.parseInt(cantidad);
        
        controlador.agregarProductoAlServicio(mesa, producto, descripcion, cantidadP);
        Servicio servicio = controlador.getServicioMesa(mesa);
        cargarServicioCompleto(servicio);
    }
    
    public void cargarServicioCompleto(Servicio servicio){
        for(int i=0; i < servicio.getItems().size(); i++){
            ItemServicio item= servicio.getItems().get(i);
            agregarItemTablaServicio(item);
        }
    }
    
    public void agregarItemTablaServicio(ItemServicio item){
        int col = dtm.getColumnCount();
        Object[] newRow = new Object[col];
        newRow[0]= item.getUnidades();
        newRow[1]= item.getProducto();
        newRow[2]= item.getDescripcion();
        newRow[3]= item.getProducto().getPrecioUnidad();
        newRow[4]= item.getSubTotal();
        newRow[5]= item.getEstado();
        newRow[6]= item.getGestorActual().getNombreCompleto();
        dtm.addRow(newRow);
    }
    
    //////////////////////////////////////////////////////////////////
    //   //CU: Cerrar una mesa                                      //               
    //////////////////////////////////////////////////////////////////
    
    private void cerrarMesa() {
        Mesa mesa= (Mesa) listMesas.getSelectedValue();
        if(mesa.isAbierta()){
            if(!mesa.getServicio().pedidosPendientes()){
                new DialogoCerrarMesa((java.awt.Frame) this.getParent(), false, this.mozo, mesa).setVisible(true);
                cargarMesasMozo();
            }else{
                mostrarError("Tiene pedidos pendientes");
            }
        }else{
            mostrarError("La mesa no está abierta");
        }
    }
    
    //////////////////////////////////////////////////////////////////
    //   //CU: Salir del sistema                                    //               
    //////////////////////////////////////////////////////////////////
    
    private void salir(){
        if(!controlador.tieneMesasAbiertas(mozo)){
            controlador.cerrarSesion(this.sesion);
            cerrarVista();
        }else{
            mostrarError("Debe cerrar las mesas abiertas antes de salir");
        }
    }

    @Override
    public void update(Observable source, Object event) {
        if(event.equals(Observer.Eventos.PEDIDOS_ACTUALIZADOS)){
            listProductos.clearSelection();
            cargarProductosDisponibles();
        }
    }

    private class MesasRenderer extends JLabel implements ListCellRenderer<Mesa> {

        @Override
        public Component getListCellRendererComponent(JList<? extends Mesa> list, Mesa m, int index, boolean isSelected, boolean cellHasFocus) {
            if(m.isAbierta()) {
                setOpaque(true);
                setBackground(Color.red);
            } else {
                setOpaque(true);
                setBackground(Color.white);
            }
            return this;
        }
    }
    
}
